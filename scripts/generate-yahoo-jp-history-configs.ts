#!/usr/bin/env tsx

import * as fs from 'fs';
import * as path from 'path';

interface StockCategory {
  name: string;
  url: string;
  categoryId: string;
}

interface JapanStockCategoriesData {
  "æ—¥è‚¡åˆ†é¡": StockCategory[];
}

interface ConfigTemplate {
  templateType?: string;
  url: string;
  variables?: Record<string, any>;
  export?: {
    filename?: string;
    [key: string]: any;
  };
  [key: string]: any;
}

// è§£æå‘½ä»¤è¡Œåƒæ•¸
const args = process.argv.slice(2);
const fromDateArg = args.find(arg => arg.startsWith('--from='));
const toDateArg = args.find(arg => arg.startsWith('--to='));
const limitArg = args.find(arg => arg.startsWith('--limit='));

// è¨­ç½®é»˜èªæ—¥æœŸç¯„åœï¼šfromDate ç‚ºä»Šæ—¥å‰14å¤©ï¼ŒtoDate ç‚ºä»Šå¤©
const now = new Date();
const fourteenDaysAgo = new Date(now.getTime() - 14 * 24 * 60 * 60 * 1000);

// æ ¼å¼åŒ–æ—¥æœŸç‚º YYYYMMDD æ ¼å¼
const formatDate = (date: Date): string => {
  return date.toISOString().split('T')[0].replace(/-/g, '');
};

const fromDate = fromDateArg ? fromDateArg.split('=')[1] : formatDate(fourteenDaysAgo);
const toDate = toDateArg ? toDateArg.split('=')[1] : formatDate(now);
const limit = limitArg ? parseInt(limitArg.split('=')[1]) : undefined; // é»˜èªç”Ÿæˆæ‰€æœ‰è‚¡ç¥¨

console.log('ğŸ” Yahoo Finance Japan æ­·å²è‚¡åƒ¹é…ç½®ç”Ÿæˆå™¨');
console.log('=====================================');
console.log(`ğŸ“… æ—¥æœŸç¯„åœ: ${fromDate} -> ${toDate} (14å¤©ç¯„åœ)`);
console.log(`ğŸ“Š ç”Ÿæˆé™åˆ¶: ${limit ? `${limit} å€‹é…ç½®` : 'æ‰€æœ‰è‚¡ç¥¨ (ç„¡é™åˆ¶)'}`);

// è®€å–æ¨¡æ¿
const templatePath = path.join(__dirname, '../config/templates/yahoo-finance-jp-history.json');
if (!fs.existsSync(templatePath)) {
  console.log('âŒ æ‰¾ä¸åˆ°æ­·å²è‚¡åƒ¹æ¨¡æ¿æ–‡ä»¶:', templatePath);
  process.exit(1);
}

// è®€å–æ—¥æœ¬è‚¡ç¥¨ä»£ç¢¼æ•¸æ“š
const stockCodesPath = path.join(__dirname, '../data/yahoo-finance-jp-stockcodes.json');
if (!fs.existsSync(stockCodesPath)) {
  console.log('âŒ æ‰¾ä¸åˆ°æ—¥æœ¬è‚¡ç¥¨ä»£ç¢¼æ•¸æ“šæ–‡ä»¶:', stockCodesPath);
  process.exit(1);
}

interface StockCode {
  stockCode: string;
  companyName: string;
  sector: string;
}

const stockCodesData: StockCode[] = JSON.parse(fs.readFileSync(stockCodesPath, 'utf8'));
const template: ConfigTemplate = JSON.parse(fs.readFileSync(templatePath, 'utf8'));

console.log(`ğŸ“‹ è®€å–åˆ° ${stockCodesData.length} å€‹æ—¥æœ¬è‚¡ç¥¨ä»£ç¢¼`);

// å¾å¯¦éš›è‚¡ç¥¨ä»£ç¢¼æ•¸æ“šä¸­é¸å–è‚¡ç¥¨ä»£ç¢¼
const getStockCodes = (stockData: StockCode[], maxCount?: number): string[] => {
  // å¦‚æœæ²’æœ‰æŒ‡å®šé™åˆ¶ï¼Œä½¿ç”¨æ‰€æœ‰è‚¡ç¥¨ä»£ç¢¼
  const stockCodes = maxCount 
    ? stockData.slice(0, maxCount).map(stock => stock.stockCode)
    : stockData.map(stock => stock.stockCode);
  
  console.log(`ğŸ“Š é¸å–äº† ${stockCodes.length} å€‹è‚¡ç¥¨ä»£ç¢¼ (åŒ…å« .T/.S å¾Œç¶´)`);
  
  return stockCodes;
};

// ç”Ÿæˆé…ç½®æ–‡ä»¶
const generateConfigs = async (): Promise<void> => {
  const stockCodes = getStockCodes(stockCodesData, limit);
  const configsDir = path.join(__dirname, '../config');
  let successCount = 0;
  let errorCount = 0;

  console.log(`ğŸš€ é–‹å§‹ç”Ÿæˆ ${stockCodes.length} å€‹æ­·å²è‚¡åƒ¹é…ç½®...`);

  for (const symbolCode of stockCodes) {
    try {
      // å‰µå»ºé…ç½®å‰¯æœ¬
      const config = JSON.parse(JSON.stringify(template));
      
      // æ›´æ–°é…ç½®
      config.variables = {
        ...config.variables,
        symbolCode,
        fromDate,
        toDate,
        page: "1"
      };
      
      // æ›´æ–° URL
      config.url = `https://finance.yahoo.co.jp/quote/${symbolCode}/history?from=${fromDate}&to=${toDate}&timeFrame=d&page=1`;
      
      // æ›´æ–°å°å‡ºæ–‡ä»¶åï¼Œæ”¯æ´ .T å’Œ .S å¾Œç¶´ï¼Œæ›¿æ›æ‰€æœ‰è®Šæ•¸ç‚ºå¯¦éš›å€¼
      if (config.export && config.export.filename) {
        config.export.filename = config.export.filename
          .replace('${symbolCode}', symbolCode.replace(/\.(T|S)$/, '_$1'))
          .replace('${fromDate}', fromDate)
          .replace('${toDate}', toDate);
      }
      
      // æ›´æ–°è¨»é‡‹
      config._note = `JP STOCK HISTORY CONFIG: Auto-generated configuration for ${symbolCode} historical stock price data from ${fromDate} to ${toDate}. Generated by generate-yahoo-jp-history-configs.ts script.`;
      
      // å¯«å…¥é…ç½®æ–‡ä»¶ï¼Œæ”¯æ´ .T å’Œ .S å¾Œç¶´
      const configFilename = `yahoo-finance-jp-history-${symbolCode.replace(/\.(T|S)$/, '_$1')}.json`;
      const configPath = path.join(configsDir, configFilename);
      
      fs.writeFileSync(configPath, JSON.stringify(config, null, 2));
      
      successCount++;
      
      if (successCount % 10 === 0) {
        console.log(`âœ… å·²ç”Ÿæˆ ${successCount} å€‹é…ç½®...`);
      }
      
    } catch (error) {
      console.error(`âŒ ç”Ÿæˆ ${symbolCode} é…ç½®æ™‚å‡ºéŒ¯:`, error);
      errorCount++;
    }
  }

  console.log('\nğŸ“Š ç”Ÿæˆçµæœçµ±è¨ˆ:');
  console.log(`âœ… æˆåŠŸç”Ÿæˆ: ${successCount} å€‹é…ç½®`);
  console.log(`âŒ ç”Ÿæˆå¤±æ•—: ${errorCount} å€‹é…ç½®`);
  console.log(`ğŸ“ é…ç½®ç›®éŒ„: ${configsDir}`);
  
  if (successCount > 0) {
    console.log('\nğŸ¯ ä½¿ç”¨æ–¹å¼:');
    console.log('npm run crawl yahoo-finance-jp-history-8105_T');
    console.log('npx tsx src/cli.ts --config config/yahoo-finance-jp-history-7203_T.json');
    console.log('\nğŸ“ æ‰¹é‡åŸ·è¡Œç¯„ä¾‹:');
    console.log('for file in config/yahoo-finance-jp-history-*.json; do');
    console.log('  echo "Processing $file..."');
    console.log('  npx tsx src/cli.ts --config "$file"');
    console.log('  sleep 10  # é¿å…é »ç¹è«‹æ±‚');
    console.log('done');
    console.log('\nğŸ’¡ æ”¯æ´äº¤æ˜“æ‰€: .T (æ±äº¬è­‰åˆ¸äº¤æ˜“æ‰€), .S (æœ­å¹Œè­‰åˆ¸äº¤æ˜“æ‰€)');
  }
};

// ä¸»è¦å‡½æ•¸
const main = async (): Promise<void> => {
  try {
    await generateConfigs();
    console.log('\nğŸ‰ Yahoo Finance Japan æ­·å²è‚¡åƒ¹é…ç½®ç”Ÿæˆå®Œæˆï¼');
  } catch (error) {
    console.error('âŒ ç”Ÿæˆéç¨‹ä¸­ç™¼ç”ŸéŒ¯èª¤:', error);
    process.exit(1);
  }
};

// åŸ·è¡Œè…³æœ¬
if (require.main === module) {
  main().catch(console.error);
}

export { main as generateYahooJPHistoryConfigs };